<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Creating a production ready API with Python and Django Rest Framework – part 4</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Andrea Grandi </a></h1>
                <nav><ul>
    
                        <li><a href="/about/">About</a></li>
    
                        <li><a href="/curriculum/">Curriculum</a></li>
    
                        <li><a href="/pgp-key/">PGP Key</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/drafts/creating-a-production-ready-api-with-python-and-django-rest-framework-part-4.html" rel="bookmark"
           title="Permalink to Creating a production ready API with Python and Django Rest Framework – part 4">Creating a production ready API with Python and Django Rest Framework – part 4</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Sun 26 March 2017</span>

</footer><!-- /.post-info -->      <p>In the <a href="https://www.andreagrandi.it/2017/03/12/creating-a-production-ready-api-with-python-and-django-rest-framework-part-3/">previous
part</a>
of the tutorial we implemented <strong>details</strong> management, <strong>relations</strong>
between models, <strong>nested APIs</strong> and a different level of permissions.
Our API is basically complete but it is working properly? Is the source
code free of bugs? Would you feel confident to refactor the code without
breaking something? The answer to all our question is probably no. <strong>I
can't be sure if the code behaves properly nor I would feel confident
refactoring anything without having some tests coverage</strong>.</p>
<p>As I mentioned previously, we should have written tests since the
beginning, but I really didn't want to mix too many concepts together
and I wanted to let the user concentrate on the Rest Framework instead.</p>
<h3>Test structure and configuration</h3>
<p>Before beginning the fourth part of this tutorial, make sure you have
grabbed the latest source code
from <a href="https://github.com/andreagrandi/drf-tutorial">https://github.com/andreagrandi/drf-tutorial</a> and you have checked
out the previous git tag:</p>
<p>``` {.lang:sh .decode:true}
git checkout tutorial-1.14</p>
<div class="highlight"><pre><span></span>Django has an integrated test runner but my personal choice is to use
[**pytest**](http://doc.pytest.org/en/latest/), so as first thing let&#39;s
install the needed libraries:

``` {.lang:sh .decode:true}
pip install pytest pytest-django
</pre></div>


<p>As long as we respect a minimum of conventions (test files must start
with <strong>test_</strong> prefix), tests can be place anywhere in the code. My
advice is to put them all together in a separate folder and divide them
according to app names. In our case we are going to create a folder
named "<strong>tests</strong>" at the same level of <strong>manage.py</strong> file. Inside this
folder we need to create a <strong>__init__.py</strong> file and another folder
called <strong>catalog</strong> with an additional <strong>__init__.py</strong> inside. Now,
still at the same level of <strong>manage.py</strong> create a file called
<strong>pytest.ini</strong> with this content:</p>
<p>``` {.lang:default .decode:true}
[pytest]
DJANGO_SETTINGS_MODULE=drftutorial.settings</p>
<div class="highlight"><pre><span></span>Are you feeling confused? No problem. You can checkout the source code
containing these changes.

``` {.lang:default .decode:true}
git checkout tutorial-1.15
</pre></div>


<p>You can check if you have done everything correctly going inside the
drftutorial folder (the one containing <strong>manage.py</strong>) and launching
<strong>pytest</strong>. If you see something like this, you did your changes
correctly:</p>
<p>``` {.lang:default .decode:true}
(drf-tutorial) ➜  drftutorial git:(master) pytest
============================================================================================================================= test session starts ==============================================================================================================================
platform darwin -- Python 2.7.13, pytest-3.0.6, py-1.4.32, pluggy-0.4.0
Django settings: drftutorial.settings (from ini file)
rootdir: /Users/andrea/Projects/drf-tutorial/drftutorial, inifile: pytest.ini
plugins: django-3.1.2
collected 0 items</p>
<p>========================================================================================================================= no tests ran in 0.01 seconds =========================================================================================================================
(drf-tutorial) ➜  drftutorial git:(master)</p>
<div class="highlight"><pre><span></span><span class="c1">### Writing the first test</span>

<span class="n">To</span> <span class="n">begin</span> <span class="k">with</span><span class="p">,</span> <span class="n">I</span> <span class="n">will</span> <span class="n">show</span> <span class="n">you</span> <span class="n">how</span> <span class="n">to</span> <span class="n">write</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">test</span> <span class="n">that</span> <span class="n">will</span>
<span class="n">verify</span> <span class="k">if</span> <span class="n">the</span> <span class="n">API</span> <span class="n">can</span> <span class="k">return</span> <span class="n">the</span> <span class="n">products</span> <span class="nb">list</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">remember</span> <span class="n">we</span>
<span class="n">implemented</span> <span class="n">this</span> <span class="n">API</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">first</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">tutorial</span><span class="o">.</span> <span class="n">First</span> <span class="n">of</span> <span class="nb">all</span>
<span class="n">create</span> <span class="n">a</span> <span class="nb">file</span> <span class="n">called</span> <span class="o">**</span><span class="n">test</span>\<span class="n">_views</span><span class="o">.</span><span class="n">py</span><span class="o">**</span> <span class="n">under</span> <span class="n">the</span> <span class="n">folder</span>
<span class="o">**</span><span class="n">drftutorial</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">catalog</span><span class="o">/**</span> <span class="ow">and</span> <span class="n">add</span> <span class="n">this</span> <span class="n">code</span><span class="p">:</span>

<span class="sb">``</span><span class="err">`</span> <span class="p">{</span><span class="o">.</span><span class="n">lang</span><span class="p">:</span><span class="n">python</span> <span class="o">.</span><span class="n">decode</span><span class="p">:</span><span class="n">true</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.test</span> <span class="kn">import</span> <span class="n">APITestCase</span>


<span class="k">class</span> <span class="nc">TestProductList</span><span class="p">(</span><span class="n">APITestCase</span><span class="p">):</span>
    <span class="nd">@pytest.mark.django_db</span>
    <span class="k">def</span> <span class="nf">test_can_get_product_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;product-list&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()),</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>


<p>before being able to run this test we need to change a little thing in
the <strong>catalog/urls.py</strong> file, something we should have done since the
beginning. Please change the first url in this way, adding the <strong>name</strong>
parameter:</p>
<p>``` {.lang:python .decode:true}
urlpatterns = [
    url(r'^products/$', views.ProductList.as_view(), name='product-list'),
    ...</p>
<div class="highlight"><pre><span></span>at this point we are able to run our test suite again and verify the
test is passing:

``` {.lang:sh .decode:true}
(drf-tutorial) ➜  drftutorial git:(test-productlist) ✗ pytest -v
============================================================================================================================= test session starts ==============================================================================================================================
platform darwin -- Python 2.7.13, pytest-3.0.6, py-1.4.32, pluggy-0.4.0 -- /Users/andrea/.virtualenvs/drf-tutorial/bin/python2.7
cachedir: .cache
Django settings: drftutorial.settings (from ini file)
rootdir: /Users/andrea/Projects/drf-tutorial/drftutorial, inifile: pytest.ini
plugins: django-3.1.2
collected 1 items

tests/catalog/test_views.py::TestProductList::test_can_get_product_list PASSED

=========================================================================================================================== 1 passed in 0.98 seconds ===========================================================================================================================
</pre></div>


<p>To checkout the source code at this point:</p>
<p><code>{.lang:sh .decode:true}
git checkout tutorial-1.16</code></p>
<h3>Explaining the test code</h3>
<p>When we implement a test, the first thing to do is to create a
<strong>test_*</strong> file and import the minimum necessary to write a test class
and method. Each test class must inherit from <strong>APITestCase</strong> and have a
name that start with <strong>Test</strong>, like <strong>TestProductList</strong>. Since we use
<a href="http://doc.pytest.org/en/latest/">pytest</a>, we need to mark our method
with <strong>@pytest.mark.django_db decorator</strong>, to tell the test suite our
code will explicitly access the database.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/andreagrandi">twitter</a></li>
                            <li><a href="https://github.com/andreagrandi">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>