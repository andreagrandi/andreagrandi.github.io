
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="https://www.andreagrandi.it/theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="https://www.andreagrandi.it/theme/pygments/monokai.min.css" id="pygments-light-theme" rel="stylesheet" type="text/css"/>
<script src="https://www.andreagrandi.it/theme/tipuesearch/jquery.min.js"></script>
<script defer="" src="https://www.andreagrandi.it/theme/tipuesearch/tipuesearch.min.js"></script>
<script defer="" src="https://www.andreagrandi.it/theme/tipuesearch/tipuesearch_set.js"></script>
<script defer="" src="https://www.andreagrandi.it/tipuesearch_content.js"></script>
<link href="https://www.andreagrandi.it/theme/tipuesearch/tipuesearch.min.css" rel="stylesheet">
<link href="https://www.andreagrandi.it/theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="https://www.andreagrandi.it/theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="https://www.andreagrandi.it/theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://www.andreagrandi.it/feeds/all.rss.xml" rel="alternate" title="Andrea Grandi RSS" type="application/rss+xml"/>
<!-- Chrome, Firefox OS and Opera -->
<meta content="#333333" name="theme-color"/>
<!-- Windows Phone -->
<meta content="#333333" name="msapplication-navbutton-color"/>
<!-- iOS Safari -->
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<!-- Microsoft EDGE -->
<meta content="#333333" name="msapplication-TileColor"/>
<meta content="Andrea Grandi" name="author">
<meta content="In the first part of this tutorial we have seen how to create a basic API using Django Rest Framework. This second part will explain how to implement POST methods and add different levels of permissions and authentication. If you are starting from part 2, you may want to checkout the source code at this exact point: git checkout tutorial-1.4 A step back Before showing how easy it is to implement a POST method for our existing API, I want to do a step back and show you the &quot;manual way&quot;, using just the APIView class. Edit the file catalog/views.py and change the code in this way: from django.http import HttpResponse from rest_framework.response import Response from rest_framework.views import APIView from .models import Product from .serializers import ProductSerializer class ProductList(APIView): def get(self, request, format=None): products = Product.objects.all() serializer = ProductSerializer(products, many=True) return Response(serializer.data) If we try to use the API again (from the browser of from the http client), it will still work in the same way. The difference here is that we are using the very basic APIView class and we have explicitly defined the GET method for it. Implementing a POST method with APIView An API is not being used at its full potential if it's read only. We are going to implement a POST method for the existing view and testing it with httpie client again. First of all we need to add an import to catalog/views.py from rest_framework import status then we add this method to our ProductList class: def post(self, request, format=None): serializer = ProductSerializer(data=request.data) if serializer.is_valid(): serializer.save() return Response(serializer.data, status=status.HTTP_201_CREATED) return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST) Now let's test our POST method we just implemented: $ http --json POST http://127.0.0.1:8000/products/ name=&quot;Salamino&quot; description=&quot;Salamino Piccante&quot; price=&quot;10.50&quot; HTTP/1.0 201 Created Allow: GET, POST, HEAD, OPTIONS Content-Type: application/json Date: Thu, 29 Sep 2016 11:48:48 GMT Server: WSGIServer/0.1 Python/2.7.10 Vary: Accept, Cookie X-Frame-Options: SAMEORIGIN { &quot;description&quot;: &quot;Salamino Piccante&quot;, &quot;name&quot;: &quot;Salamino&quot;, &quot;price&quot;: &quot;10.50&quot; } It works! In case something doesn't work, try to fetch the source code at this point: git checkout tutorial-1.7 Implementing a POST method with ListCreateAPIView Do you remember when I mentioned at the beginning that there is an easy way to do the same thing? I wasn't cheating. Let's change again our old code in catalog/views.py but this time we will use a different base class: from django.http import HttpResponse from rest_framework import generics from rest_framework.response import Response from .models import Product from .serializers import ProductSerializer class ProductList(generics.ListCreateAPIView): queryset = Product.objects.all() serializer_class = ProductSerializer let's test this again with httpie: $ http --json POST http://127.0.0.1:8000/products/ name=&quot;Pecorino&quot; description=&quot;Pecorino Sardo&quot; price=&quot;7.00&quot; HTTP/1.0 201 Created Allow: GET, POST, HEAD, OPTIONS Content-Type: application/json Date: Thu, 29 Sep 2016 15:21:20 GMT Server: WSGIServer/0.1 Python/2.7.10 Vary: Accept, Cookie X-Frame-Options: SAMEORIGIN { &quot;description&quot;: &quot;Pecorino Sardo&quot;, &quot;name&quot;: &quot;Pecorino&quot;, &quot;price&quot;: &quot;7.00&quot; } We just POSTed some data on the API! How can it work? Well, we have changed the base class from ListAPIView to ListCreateAPIView. This particular class implements a generic POST method that will accept and validate all the fields through the specified serializer. Authentication Now our API let us add products to the catalog, amazing! But... is it exactly what we want? In a real scenario we don't want any random user to be able to add products in our database, so we are going to protect the POST method allowing only Admin users. Before digging into Django Rest Framework permissions, we need to setup an authentication system. For simplicity we will implement TokenAuthentication. As first step we need to edit settings.py and insert rest_framework.authtoken in the INSTALLED_APPS: ... 'rest_framework', 'rest_framework.authtoken', 'catalog', ] after this, we need to add TokenAuthentication as default authentication class (append this in settings.py at the end): REST_FRAMEWORK = { 'DEFAULT_AUTHENTICATION_CLASSES': ( 'rest_framework.authentication.TokenAuthentication', ) } Finally we need to add a particular URL to the project so that clients will be able to call an endpoint passing username and password to get a token back. Edit drftutorial/urls.py and make it's like this: from django.conf.urls import url, include from django.contrib import admin from rest_framework.authtoken.views import obtain_auth_token urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^', include('catalog.urls')), url(r'^api-token-auth/', obtain_auth_token), ] Don't forget to re-run the migrations, because TokenAuthorization needs to change a couple of tables: $ ./manage.py migrate Operations to perform: Apply all migrations: admin, auth, authtoken, catalog, contenttypes, sessions Running migrations: Applying authtoken.0001_initial... OK Applying authtoken.0002_auto_20160226_1747... OK In case you had any problem changing the code up to this point, you can always fetch the related git tag: git checkout tutorial-1.9 Testing the Authentication Before testing the authentication, make sure you created at least the Django superuser with: $ ./manage.py createsuperuser now let's try to obtain the token we will need later for our API calls: $ http --json POST http://127.0.0.1:8000/api-token-auth/ username=&quot;yourusername&quot; password=&quot;yourpassword&quot; HTTP/1.0 200 OK Allow: POST, OPTIONS Content-Type: application/json Date: Fri, 30 Sep 2016 08:55:07 GMT Server: WSGIServer/0.1 Python/2.7.11 X-Frame-Options: SAMEORIGIN { &quot;token&quot;: &quot;bc9514f0892368cfd0ea792a977aff55d53e3634&quot; } We will need to pass this token in every API call we want to be authenticated. The token is being passed through the &quot;Authentication&quot; header parameter. API Permissions Authentication is something that identify the user with a particular system. Permissions instead are the level of things that are allowed or not allowed for a particular user. In our case we said we want to let Admin users to be able to POST new products and we want to let even anonymous users to GET the product list. Django Rest Framework has some built-in classes that we can apply to our views to define the level of permissions. We could have used the IsAdminUser class, but it would not allow anonymous users to perform the GET request. Or we could have used IsAuthenticatedOrReadOnly class, but this would allow any registered user to add products (and we want to let only admins). Or...we can define our own permission class and have exactly what we want. Create a new file catalog/permissions.py from rest_framework.permissions import BasePermission, SAFE_METHODS class IsAdminOrReadOnly(BasePermission): def has_permission(self, request, view): if request.method in SAFE_METHODS: return True else: return request.user.is_staff Just as a side note, SAFE_METHODS are GET, HEAD and OPTIONS. These method are considered &quot;safe&quot; because they don't change any existing data. Open catalog/views.py again, import this at the beginning: from .permissions import IsAdminOrReadOnly and set this as permission_classes to ProductList: ... serializer_class = ProductSerializer permission_classes = (IsAdminOrReadOnly, ) Let's now try to add a new product using the token we got before (you will have to use your own token of course, mine only works on my local db): $ http --json POST http://127.0.0.1:8000/products/ name=&quot;Lardo&quot; description=&quot;Lardo di Colonnata&quot; price=&quot;8.50&quot; 'Authorization: Token bc9514f0892368cfd0ea792a977aff55d53e3634' HTTP/1.0 201 Created Allow: GET, POST, HEAD, OPTIONS Content-Type: application/json Date: Fri, 30 Sep 2016 13:04:13 GMT Server: WSGIServer/0.1 Python/2.7.11 Vary: Accept X-Frame-Options: SAMEORIGIN { &quot;description&quot;: &quot;Lardo di Colonnata&quot;, &quot;name&quot;: &quot;Lardo&quot;, &quot;price&quot;: &quot;8.50&quot; } It worked! We have now protected our API so that not admin people can't create any product. If you have any problem with the code, you can check it out with this tag: git checkout tutorial-1.10 Wrapping Up We have now implemented the POST method to add new products to our catalog. In the next episode we will see how to implement endpoints to get a single product, to update or delete products and finally we will allow registered users to send a review for a specific product. Feedback Please I know, this blog doesn't have any &quot;comment&quot; feature (I was tired of dealing with spam), but if you want to provide some feedback you can still do it by email. Just visit my About page, you will find my email there." name="description">
<meta content="API, Django, framework, Python, rest, tutorial" name="keywords"/>
<meta content="Andrea Grandi" property="og:site_name">
<meta content="Creating a production ready API with Python and Django Rest Framework – part 2" property="og:title">
<meta content="In the first part of this tutorial we have seen how to create a basic API using Django Rest Framework. This second part will explain how to implement POST methods and add different levels of permissions and authentication. If you are starting from part 2, you may want to checkout the source code at this exact point: git checkout tutorial-1.4 A step back Before showing how easy it is to implement a POST method for our existing API, I want to do a step back and show you the &quot;manual way&quot;, using just the APIView class. Edit the file catalog/views.py and change the code in this way: from django.http import HttpResponse from rest_framework.response import Response from rest_framework.views import APIView from .models import Product from .serializers import ProductSerializer class ProductList(APIView): def get(self, request, format=None): products = Product.objects.all() serializer = ProductSerializer(products, many=True) return Response(serializer.data) If we try to use the API again (from the browser of from the http client), it will still work in the same way. The difference here is that we are using the very basic APIView class and we have explicitly defined the GET method for it. Implementing a POST method with APIView An API is not being used at its full potential if it's read only. We are going to implement a POST method for the existing view and testing it with httpie client again. First of all we need to add an import to catalog/views.py from rest_framework import status then we add this method to our ProductList class: def post(self, request, format=None): serializer = ProductSerializer(data=request.data) if serializer.is_valid(): serializer.save() return Response(serializer.data, status=status.HTTP_201_CREATED) return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST) Now let's test our POST method we just implemented: $ http --json POST http://127.0.0.1:8000/products/ name=&quot;Salamino&quot; description=&quot;Salamino Piccante&quot; price=&quot;10.50&quot; HTTP/1.0 201 Created Allow: GET, POST, HEAD, OPTIONS Content-Type: application/json Date: Thu, 29 Sep 2016 11:48:48 GMT Server: WSGIServer/0.1 Python/2.7.10 Vary: Accept, Cookie X-Frame-Options: SAMEORIGIN { &quot;description&quot;: &quot;Salamino Piccante&quot;, &quot;name&quot;: &quot;Salamino&quot;, &quot;price&quot;: &quot;10.50&quot; } It works! In case something doesn't work, try to fetch the source code at this point: git checkout tutorial-1.7 Implementing a POST method with ListCreateAPIView Do you remember when I mentioned at the beginning that there is an easy way to do the same thing? I wasn't cheating. Let's change again our old code in catalog/views.py but this time we will use a different base class: from django.http import HttpResponse from rest_framework import generics from rest_framework.response import Response from .models import Product from .serializers import ProductSerializer class ProductList(generics.ListCreateAPIView): queryset = Product.objects.all() serializer_class = ProductSerializer let's test this again with httpie: $ http --json POST http://127.0.0.1:8000/products/ name=&quot;Pecorino&quot; description=&quot;Pecorino Sardo&quot; price=&quot;7.00&quot; HTTP/1.0 201 Created Allow: GET, POST, HEAD, OPTIONS Content-Type: application/json Date: Thu, 29 Sep 2016 15:21:20 GMT Server: WSGIServer/0.1 Python/2.7.10 Vary: Accept, Cookie X-Frame-Options: SAMEORIGIN { &quot;description&quot;: &quot;Pecorino Sardo&quot;, &quot;name&quot;: &quot;Pecorino&quot;, &quot;price&quot;: &quot;7.00&quot; } We just POSTed some data on the API! How can it work? Well, we have changed the base class from ListAPIView to ListCreateAPIView. This particular class implements a generic POST method that will accept and validate all the fields through the specified serializer. Authentication Now our API let us add products to the catalog, amazing! But... is it exactly what we want? In a real scenario we don't want any random user to be able to add products in our database, so we are going to protect the POST method allowing only Admin users. Before digging into Django Rest Framework permissions, we need to setup an authentication system. For simplicity we will implement TokenAuthentication. As first step we need to edit settings.py and insert rest_framework.authtoken in the INSTALLED_APPS: ... 'rest_framework', 'rest_framework.authtoken', 'catalog', ] after this, we need to add TokenAuthentication as default authentication class (append this in settings.py at the end): REST_FRAMEWORK = { 'DEFAULT_AUTHENTICATION_CLASSES': ( 'rest_framework.authentication.TokenAuthentication', ) } Finally we need to add a particular URL to the project so that clients will be able to call an endpoint passing username and password to get a token back. Edit drftutorial/urls.py and make it's like this: from django.conf.urls import url, include from django.contrib import admin from rest_framework.authtoken.views import obtain_auth_token urlpatterns = [ url(r'^admin/', admin.site.urls), url(r'^', include('catalog.urls')), url(r'^api-token-auth/', obtain_auth_token), ] Don't forget to re-run the migrations, because TokenAuthorization needs to change a couple of tables: $ ./manage.py migrate Operations to perform: Apply all migrations: admin, auth, authtoken, catalog, contenttypes, sessions Running migrations: Applying authtoken.0001_initial... OK Applying authtoken.0002_auto_20160226_1747... OK In case you had any problem changing the code up to this point, you can always fetch the related git tag: git checkout tutorial-1.9 Testing the Authentication Before testing the authentication, make sure you created at least the Django superuser with: $ ./manage.py createsuperuser now let's try to obtain the token we will need later for our API calls: $ http --json POST http://127.0.0.1:8000/api-token-auth/ username=&quot;yourusername&quot; password=&quot;yourpassword&quot; HTTP/1.0 200 OK Allow: POST, OPTIONS Content-Type: application/json Date: Fri, 30 Sep 2016 08:55:07 GMT Server: WSGIServer/0.1 Python/2.7.11 X-Frame-Options: SAMEORIGIN { &quot;token&quot;: &quot;bc9514f0892368cfd0ea792a977aff55d53e3634&quot; } We will need to pass this token in every API call we want to be authenticated. The token is being passed through the &quot;Authentication&quot; header parameter. API Permissions Authentication is something that identify the user with a particular system. Permissions instead are the level of things that are allowed or not allowed for a particular user. In our case we said we want to let Admin users to be able to POST new products and we want to let even anonymous users to GET the product list. Django Rest Framework has some built-in classes that we can apply to our views to define the level of permissions. We could have used the IsAdminUser class, but it would not allow anonymous users to perform the GET request. Or we could have used IsAuthenticatedOrReadOnly class, but this would allow any registered user to add products (and we want to let only admins). Or...we can define our own permission class and have exactly what we want. Create a new file catalog/permissions.py from rest_framework.permissions import BasePermission, SAFE_METHODS class IsAdminOrReadOnly(BasePermission): def has_permission(self, request, view): if request.method in SAFE_METHODS: return True else: return request.user.is_staff Just as a side note, SAFE_METHODS are GET, HEAD and OPTIONS. These method are considered &quot;safe&quot; because they don't change any existing data. Open catalog/views.py again, import this at the beginning: from .permissions import IsAdminOrReadOnly and set this as permission_classes to ProductList: ... serializer_class = ProductSerializer permission_classes = (IsAdminOrReadOnly, ) Let's now try to add a new product using the token we got before (you will have to use your own token of course, mine only works on my local db): $ http --json POST http://127.0.0.1:8000/products/ name=&quot;Lardo&quot; description=&quot;Lardo di Colonnata&quot; price=&quot;8.50&quot; 'Authorization: Token bc9514f0892368cfd0ea792a977aff55d53e3634' HTTP/1.0 201 Created Allow: GET, POST, HEAD, OPTIONS Content-Type: application/json Date: Fri, 30 Sep 2016 13:04:13 GMT Server: WSGIServer/0.1 Python/2.7.11 Vary: Accept X-Frame-Options: SAMEORIGIN { &quot;description&quot;: &quot;Lardo di Colonnata&quot;, &quot;name&quot;: &quot;Lardo&quot;, &quot;price&quot;: &quot;8.50&quot; } It worked! We have now protected our API so that not admin people can't create any product. If you have any problem with the code, you can check it out with this tag: git checkout tutorial-1.10 Wrapping Up We have now implemented the POST method to add new products to our catalog. In the next episode we will see how to implement endpoints to get a single product, to update or delete products and finally we will allow registered users to send a review for a specific product. Feedback Please I know, this blog doesn't have any &quot;comment&quot; feature (I was tired of dealing with spam), but if you want to provide some feedback you can still do it by email. Just visit my About page, you will find my email there." property="og:description">
<meta content="en_US" property="og:locale">
<meta content="https://www.andreagrandi.it/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2/" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2016-10-01 11:12:00+02:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="https://www.andreagrandi.it/author/andrea-grandi.html" property="article:author"/>
<meta content="Development" property="article:section">
<meta content="API" property="article:tag"/>
<meta content="Django" property="article:tag"/>
<meta content="framework" property="article:tag"/>
<meta content="Python" property="article:tag"/>
<meta content="rest" property="article:tag"/>
<meta content="tutorial" property="article:tag"/>
<meta content="/images/me_pycon_2019_2_300x300.jpg" property="og:image"/>
<title>Andrea Grandi – Creating a production ready API with Python and Django Rest Framework – part 2</title>
<link href="https://www.andreagrandi.it/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2/" rel="canonical">
<link href="https://mastodon.social/@andreagrandi" rel="me">
</link></link></meta></meta></meta></meta></meta></meta></meta></link><link href="https://www.andreagrandi.it/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2/" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Andrea Grandi", "item": "https://www.andreagrandi.it"}, {"@type": "ListItem", "position": 2, "name": "2016", "item": "https://www.andreagrandi.it/2016"}, {"@type": "ListItem", "position": 3, "name": "10", "item": "https://www.andreagrandi.it/2016/10"}, {"@type": "ListItem", "position": 4, "name": "01", "item": "https://www.andreagrandi.it/2016/10/01"}, {"@type": "ListItem", "position": 5, "name": "Creating a production ready api with python and django rest framework part 2", "item": "https://www.andreagrandi.it/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2"}, {"@type": "ListItem", "position": 6, "name": "Index", "item": "https://www.andreagrandi.it/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Andrea Grandi"}, "publisher": {"@type": "Organization", "name": "Andrea Grandi"}, "headline": "Creating a production ready API with Python and Django Rest Framework – part 2", "about": "Development", "datePublished": "2016-10-01 11:12"}</script></head>
<body class="light-theme">
<aside>
<div>
<a href="https://www.andreagrandi.it">
<img alt="Andrea Grandi" src="/images/me_pycon_2019_2_300x300.jpg" title="Andrea Grandi"/>
</a>
<h1>
<a href="https://www.andreagrandi.it">Andrea Grandi</a>
</h1>
<p>Software Developer</p>
<form action="/search.html" class="navbar-search" role="search">
<input id="tipue_search_input" name="q" placeholder="Search..." type="text"/>
</form>
<nav>
<ul class="list">
<li>
<a href="https://www.andreagrandi.it/about/" target="_self">
              About
            </a>
</li>
<li>
<a href="https://www.andreagrandi.it/curriculum/" target="_self">
              Curriculum
            </a>
</li>
<li>
<a href="https://www.andreagrandi.it/pgp-key/" target="_self">
              PGP Key
            </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-mastodon" href="https://mastodon.social/@andreagrandi" rel="me" target="_blank">
<i class="fab fa-mastodon"></i>
</a>
</li>
<li>
<a class="sc-github" href="https://github.com/andreagrandi" target="_blank">
<i class="fab fa-github"></i>
</a>
</li>
<li>
<a class="sc-linkedin" href="https://www.linkedin.com/in/andreagrandi/" target="_blank">
<i class="fab fa-linkedin"></i>
</a>
</li>
</ul>
</div>
<a href="https://tree-nation.com/profile/impact/andreagrandi#co2" style="position:relative;cursor:pointer;display:block;z-index:999;" target="_blank">
<img src="https://tree-nation.com/images/tracking/label-co2-website-white-en.png" style="width:157px;height:auto;"/>
</a>
<script src="https://tree-nation.com/js/track.js"></script>
<script>treenation_track("63a8beb06e6e6");</script>
</aside>
<main>
<nav>
<a href="https://www.andreagrandi.it">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://www.andreagrandi.it/feeds/all.rss.xml">RSS</a>
</nav>
<article class="single">
<header>
<h1 id="creating-a-production-ready-api-with-python-and-django-rest-framework-part-2">Creating a production ready API with Python and Django Rest Framework – part 2</h1>
<p>
      Posted on Sat 01 October 2016 in <a href="https://www.andreagrandi.it/category/development.html">Development</a>
</p>
</header>
<div>
<p>In the <a href="https://www.andreagrandi.it/2016/09/28/creating-production-ready-api-python-django-rest-framework-part-1/">first
part</a>
of this tutorial we have seen how to create a basic API using <strong>Django
Rest Framework</strong>. This second part will explain how to implement
<strong>POST</strong> methods and add different levels of <strong>permissions</strong> and
<strong>authentication</strong>. If you are starting from part 2, you may want to
checkout the source code at this exact point:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.4
</code></pre></div>
<h3>A step back</h3>
<p>Before showing how easy it is to implement a <strong>POST</strong> method for our
existing API, I want to do a step back and show you the "manual way",
using just the
<a href="http://www.django-rest-framework.org/api-guide/views/"><strong>APIView</strong></a>
class. Edit the file <strong>catalog/views.py</strong> and change the code in this
way:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ProductSerializer</span>


<span class="k">class</span> <span class="nc">ProductList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ProductSerializer</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<p>If we try to use the API again (from the browser of from the http
client), it will still work in the same way. The difference here is that
we are using the very basic <strong>APIView</strong> class and we have explicitly
defined the <strong>GET</strong> method for it.</p>
<h3>Implementing a POST method with APIView</h3>
<p>An API is not being used at its full potential if it's read only. We are
going to implement a POST method for the existing view and testing it
with <a href="https://httpie.org/"><strong>httpie</strong></a> client again. First of all we
need to add an import to <strong>catalog/views.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
</code></pre></div>
<p>then we add this method to our <strong>ProductList</strong> class:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">ProductSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div>
<p>Now let's test our <strong>POST</strong> method we just implemented:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>http<span class="w"> </span>--json<span class="w"> </span>POST<span class="w"> </span>http://127.0.0.1:8000/products/<span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="s2">"Salamino"</span><span class="w"> </span><span class="nv">description</span><span class="o">=</span><span class="s2">"Salamino Piccante"</span><span class="w"> </span><span class="nv">price</span><span class="o">=</span><span class="s2">"10.50"</span>
HTTP/1.0<span class="w"> </span><span class="m">201</span><span class="w"> </span>Created
Allow:<span class="w"> </span>GET,<span class="w"> </span>POST,<span class="w"> </span>HEAD,<span class="w"> </span>OPTIONS
Content-Type:<span class="w"> </span>application/json
Date:<span class="w"> </span>Thu,<span class="w"> </span><span class="m">29</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">11</span>:48:48<span class="w"> </span>GMT
Server:<span class="w"> </span>WSGIServer/0.1<span class="w"> </span>Python/2.7.10
Vary:<span class="w"> </span>Accept,<span class="w"> </span>Cookie
X-Frame-Options:<span class="w"> </span>SAMEORIGIN

<span class="o">{</span>
<span class="w">    </span><span class="s2">"description"</span>:<span class="w"> </span><span class="s2">"Salamino Piccante"</span>,
<span class="w">    </span><span class="s2">"name"</span>:<span class="w"> </span><span class="s2">"Salamino"</span>,
<span class="w">    </span><span class="s2">"price"</span>:<span class="w"> </span><span class="s2">"10.50"</span>
<span class="o">}</span>
</code></pre></div>
<p>It works! In case something doesn't work, try to fetch the source code
at this point:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.7
</code></pre></div>
<h3>Implementing a POST method with ListCreateAPIView</h3>
<p>Do you remember when I mentioned at the beginning that there is an easy
way to do the same thing? I wasn't cheating. Let's change again our old
code in <strong>catalog/views.py</strong> but this time we will use a different base
class:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ProductSerializer</span>


<span class="k">class</span> <span class="nc">ProductList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ProductSerializer</span>
</code></pre></div>
<p>let's test this again with <strong>httpie</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>http<span class="w"> </span>--json<span class="w"> </span>POST<span class="w"> </span>http://127.0.0.1:8000/products/<span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="s2">"Pecorino"</span><span class="w"> </span><span class="nv">description</span><span class="o">=</span><span class="s2">"Pecorino Sardo"</span><span class="w"> </span><span class="nv">price</span><span class="o">=</span><span class="s2">"7.00"</span>
HTTP/1.0<span class="w"> </span><span class="m">201</span><span class="w"> </span>Created
Allow:<span class="w"> </span>GET,<span class="w"> </span>POST,<span class="w"> </span>HEAD,<span class="w"> </span>OPTIONS
Content-Type:<span class="w"> </span>application/json
Date:<span class="w"> </span>Thu,<span class="w"> </span><span class="m">29</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">15</span>:21:20<span class="w"> </span>GMT
Server:<span class="w"> </span>WSGIServer/0.1<span class="w"> </span>Python/2.7.10
Vary:<span class="w"> </span>Accept,<span class="w"> </span>Cookie
X-Frame-Options:<span class="w"> </span>SAMEORIGIN

<span class="o">{</span>
<span class="w">    </span><span class="s2">"description"</span>:<span class="w"> </span><span class="s2">"Pecorino Sardo"</span>,
<span class="w">    </span><span class="s2">"name"</span>:<span class="w"> </span><span class="s2">"Pecorino"</span>,
<span class="w">    </span><span class="s2">"price"</span>:<span class="w"> </span><span class="s2">"7.00"</span>
<span class="o">}</span>
</code></pre></div>
<p>We just POSTed some data on the API! How can it work? Well, we have
changed the base class from <strong>ListAPIView</strong> to
<a href="http://www.django-rest-framework.org/api-guide/generic-views/#listcreateapiview"><strong>ListCreateAPIView</strong></a>.
This particular class implements <strong>a generic POST method</strong> that will
accept and validate all the fields through the specified serializer.</p>
<h3>Authentication</h3>
<p>Now our API let us add products to the catalog, amazing! But... is it
exactly what we want? In a real scenario we don't want any random user
to be able to add products in our database, so we are going to protect
the POST method allowing only Admin users.</p>
<p>Before digging into Django Rest Framework permissions, we need to setup
an authentication system. For simplicity we will implement
<a href="http://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication"><strong>TokenAuthentication</strong></a>.
As first step we need to edit <strong>settings.py</strong> and
insert <strong>rest_framework.authtoken</strong> in the <strong>INSTALLED_APPS</strong>:</p>
<div class="highlight"><pre><span></span><code>    <span class="o">...</span>
    <span class="s1">'rest_framework'</span><span class="p">,</span>
    <span class="s1">'rest_framework.authtoken'</span><span class="p">,</span>
    <span class="s1">'catalog'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
<p>after this, we need to add <strong>TokenAuthentication</strong> as default
authentication class (append this in <strong>settings.py</strong> at the end):</p>
<div class="highlight"><pre><span></span><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">'rest_framework.authentication.TokenAuthentication'</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Finally we need to add a particular URL to the project so that clients
will be able to call an endpoint passing <strong>username</strong> and <strong>password</strong>
to get a <strong>token</strong> back. Edit <strong>drftutorial/urls.py</strong> and make it's like
this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">rest_framework.authtoken.views</span> <span class="kn">import</span> <span class="n">obtain_auth_token</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'catalog.urls'</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^api-token-auth/'</span><span class="p">,</span> <span class="n">obtain_auth_token</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>
<p>Don't forget to re-run the <strong>migrations</strong>, because TokenAuthorization
needs to change a couple of tables:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./manage.py<span class="w"> </span>migrate
Operations<span class="w"> </span>to<span class="w"> </span>perform:
<span class="w">    </span>Apply<span class="w"> </span>all<span class="w"> </span>migrations:<span class="w"> </span>admin,<span class="w"> </span>auth,<span class="w"> </span>authtoken,<span class="w"> </span>catalog,<span class="w"> </span>contenttypes,<span class="w"> </span>sessions
Running<span class="w"> </span>migrations:
<span class="w">    </span>Applying<span class="w"> </span>authtoken.0001_initial...<span class="w"> </span>OK
<span class="w">    </span>Applying<span class="w"> </span>authtoken.0002_auto_20160226_1747...<span class="w"> </span>OK
</code></pre></div>
<p>In case you had any problem changing the code up to this point, you can
always fetch the related git tag:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.9
</code></pre></div>
<h4>Testing the Authentication</h4>
<p>Before testing the authentication, make sure you created at least the
Django <strong>superuser</strong> with:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./manage.py<span class="w"> </span>createsuperuser
</code></pre></div>
<p>now let's try to <strong>obtain the token</strong> we will need later for our API
calls:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>http<span class="w"> </span>--json<span class="w"> </span>POST<span class="w"> </span>http://127.0.0.1:8000/api-token-auth/<span class="w"> </span><span class="nv">username</span><span class="o">=</span><span class="s2">"yourusername"</span><span class="w"> </span><span class="nv">password</span><span class="o">=</span><span class="s2">"yourpassword"</span>
HTTP/1.0<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK
Allow:<span class="w"> </span>POST,<span class="w"> </span>OPTIONS
Content-Type:<span class="w"> </span>application/json
Date:<span class="w"> </span>Fri,<span class="w"> </span><span class="m">30</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">08</span>:55:07<span class="w"> </span>GMT
Server:<span class="w"> </span>WSGIServer/0.1<span class="w"> </span>Python/2.7.11
X-Frame-Options:<span class="w"> </span>SAMEORIGIN

<span class="o">{</span>
<span class="w">    </span><span class="s2">"token"</span>:<span class="w"> </span><span class="s2">"bc9514f0892368cfd0ea792a977aff55d53e3634"</span>
<span class="o">}</span>
</code></pre></div>
<p>We will need to pass this token in every API call we want to be
authenticated. The token is being passed through the "Authentication"
header parameter.</p>
<h3>API Permissions</h3>
<p>Authentication is something that identify the user with a particular
system. Permissions instead are the level of things that are allowed or
not allowed for a particular user. In our case we said we want to let
Admin users to be able to POST new products and we want to let even
anonymous users to GET the product list.</p>
<p>Django Rest Framework has some built-in classes that we can apply to our
views to define the level of permissions. We could have used the
<a href="http://www.django-rest-framework.org/api-guide/permissions/#isadminuser"><strong>IsAdminUser</strong></a>
class, but it would not allow anonymous users to perform the GET
request. Or we could have used
<a href="http://www.django-rest-framework.org/api-guide/permissions/#isauthenticatedorreadonly"><strong>IsAuthenticatedOrReadOnly</strong></a>
class, but this would allow any registered user to add products (and we
want to let only admins).</p>
<p>Or...we can define our own permission class and have exactly what we
want. Create a new file <strong>catalog/permissions.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span><span class="p">,</span> <span class="n">SAFE_METHODS</span>


<span class="k">class</span> <span class="nc">IsAdminOrReadOnly</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span>
</code></pre></div>
<p>Just as a side note, <strong>SAFE_METHODS</strong> are <strong>GET</strong>, <strong>HEAD</strong> and
<strong>OPTIONS</strong>. These method are considered "safe" because they don't
change any existing data. Open <strong>catalog/views.py</strong> again, import this
at the beginning:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">.permissions</span> <span class="kn">import</span> <span class="n">IsAdminOrReadOnly</span>
</code></pre></div>
<p>and set this as <strong>permission_classes</strong> to <strong>ProductList</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ProductSerializer</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAdminOrReadOnly</span><span class="p">,</span> <span class="p">)</span>
</code></pre></div>
<p>Let's now try to add a new product using the <strong>token</strong> we got before
(you will have to use your own token of course, mine only works on my
local db):</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>http<span class="w"> </span>--json<span class="w"> </span>POST<span class="w"> </span>http://127.0.0.1:8000/products/<span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="s2">"Lardo"</span><span class="w"> </span><span class="nv">description</span><span class="o">=</span><span class="s2">"Lardo di Colonnata"</span><span class="w"> </span><span class="nv">price</span><span class="o">=</span><span class="s2">"8.50"</span><span class="w"> </span><span class="s1">'Authorization: Token bc9514f0892368cfd0ea792a977aff55d53e3634'</span>
HTTP/1.0<span class="w"> </span><span class="m">201</span><span class="w"> </span>Created
Allow:<span class="w"> </span>GET,<span class="w"> </span>POST,<span class="w"> </span>HEAD,<span class="w"> </span>OPTIONS
Content-Type:<span class="w"> </span>application/json
Date:<span class="w"> </span>Fri,<span class="w"> </span><span class="m">30</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">13</span>:04:13<span class="w"> </span>GMT
Server:<span class="w"> </span>WSGIServer/0.1<span class="w"> </span>Python/2.7.11
Vary:<span class="w"> </span>Accept
X-Frame-Options:<span class="w"> </span>SAMEORIGIN

<span class="o">{</span>
<span class="w">    </span><span class="s2">"description"</span>:<span class="w"> </span><span class="s2">"Lardo di Colonnata"</span>,
<span class="w">    </span><span class="s2">"name"</span>:<span class="w"> </span><span class="s2">"Lardo"</span>,
<span class="w">    </span><span class="s2">"price"</span>:<span class="w"> </span><span class="s2">"8.50"</span>
<span class="o">}</span>
</code></pre></div>
<p>It worked! We have now protected our API so that not admin people can't
create any product. If you have any problem with the code, you can check
it out with this tag:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.10
</code></pre></div>
<h3>Wrapping Up</h3>
<p>We have now implemented the POST method to add new products to our
catalog. In the <a href="https://www.andreagrandi.it/2017/03/12/creating-a-production-ready-api-with-python-and-django-rest-framework-part-3/">next
episode</a>
we will see how to implement endpoints to get a single product, to
update or delete products and finally we will allow registered users to
send a review for a specific product.</p>
<h3>Feedback Please</h3>
<p>I know, this blog doesn't have any "comment" feature (I was tired of
dealing with spam), but if you want to provide some feedback you can
still do it by email. Just visit my
<a href="https://www.andreagrandi.it/about/"><strong>About</strong></a> page, you will find my
email there.</p>
</div>
<div class="tag-cloud">
<p>
<a href="https://www.andreagrandi.it/tag/api.html">API</a>
<a href="https://www.andreagrandi.it/tag/django.html">Django</a>
<a href="https://www.andreagrandi.it/tag/framework.html">framework</a>
<a href="https://www.andreagrandi.it/tag/python.html">Python</a>
<a href="https://www.andreagrandi.it/tag/rest.html">rest</a>
<a href="https://www.andreagrandi.it/tag/tutorial.html">tutorial</a>
</p>
</div>
<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'andrea-grandi-it';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>
<footer>
<p>
  © 2024  - This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
  Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme - source code available on <a href="https://github.com/andreagrandi/andreagrandi.it" target="_blank">GitHub</a>
</p><p>
<a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="/images/by-sa.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p> </footer>
</main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Andrea Grandi ",
  "url" : "https://www.andreagrandi.it",
  "image": "/images/me_pycon_2019_2_300x300.jpg",
  "description": ""
}
</script>
<script>
    $(document).ready(function () {
      $('#tipue_search_input').tipuesearch();
    });
  </script>
</body>
</html>