
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link
    href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="https://www.andreagrandi.it/theme/stylesheet/style.min.css">


  <link id="pygments-light-theme" rel="stylesheet" type="text/css"     href="https://www.andreagrandi.it/theme/pygments/monokai.min.css">

  <script src="https://www.andreagrandi.it/theme/tipuesearch/jquery.min.js"></script>
  <script defer src="https://www.andreagrandi.it/theme/tipuesearch/tipuesearch.min.js"></script>
  <script defer src="https://www.andreagrandi.it/theme/tipuesearch/tipuesearch_set.js"></script>
  <script defer src="https://www.andreagrandi.it/tipuesearch_content.js"></script>
  <link rel="stylesheet" href="https://www.andreagrandi.it/theme/tipuesearch/tipuesearch.min.css" />

  <link rel="stylesheet" type="text/css" href="https://www.andreagrandi.it/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.andreagrandi.it/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.andreagrandi.it/theme/font-awesome/css/solid.css">



  <link href="https://www.andreagrandi.it/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
    title="Andrea Grandi RSS">


<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2140684-3', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
  <!-- Chrome, Firefox OS and Opera -->
  <meta name="theme-color" content="#333333">
  <!-- Windows Phone -->
  <meta name="msapplication-navbutton-color" content="#333333">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Microsoft EDGE -->
  <meta name="msapplication-TileColor" content="#333333">

  <meta name="author" content="Andrea Grandi" />
  <meta name="description" content="" />
<meta property="og:site_name" content="Andrea Grandi"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Andrea Grandi"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.andreagrandi.it"/>
<meta property="og:image" content="/images/me_pycon_2019_2_300x300.jpg">

  <title>Andrea Grandi &ndash; Tag tutorial</title>



  <link rel="me" href="https://mastodon.social/@andreagrandi" />
</head>

<body class="light-theme"
>
  <aside>
    <div>
      <a href="https://www.andreagrandi.it">
        <img src="/images/me_pycon_2019_2_300x300.jpg" alt="Andrea Grandi" title="Andrea Grandi">
      </a>

      <h1>
        <a href="https://www.andreagrandi.it">Andrea Grandi</a>
      </h1>

<p>Software Developer</p>
      <form class="navbar-search" action="/search.html" role="search">
        <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
      </form>

      <nav>
        <ul class="list">


          <li>
            <a target="_self"
              href="https://www.andreagrandi.it/about/">
              About
            </a>
          </li>
          <li>
            <a target="_self"
              href="https://www.andreagrandi.it/curriculum/">
              Curriculum
            </a>
          </li>
          <li>
            <a target="_self"
              href="https://www.andreagrandi.it/pgp-key/">
              PGP Key
            </a>
          </li>

        </ul>
      </nav>

      <ul class="social">
        <li>
          <a rel="me"  class="sc-mastodon" href="https://mastodon.social/@andreagrandi" target="_blank">
            <i class="fab fa-mastodon"></i>
          </a>
        </li>
        <li>
          <a  class="sc-github" href="https://github.com/andreagrandi" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        </li>
        <li>
          <a  class="sc-linkedin" href="https://www.linkedin.com/in/andreagrandi/" target="_blank">
            <i class="fab fa-linkedin"></i>
          </a>
        </li>
      </ul>
    </div>


    <a href="https://tree-nation.com/profile/impact/andreagrandi#co2" target="_blank" style="position:relative;cursor:pointer;display:block;z-index:999;">
    <img src="https://tree-nation.com/images/tracking/label-co2-website-white-en.png" style="width:157px;height:auto;">
    </a>
    <script src="https://tree-nation.com/js/track.js"></script>
    <script>treenation_track("63a8beb06e6e6");</script>
  </aside>
  <main>

    <nav>
      <a href="https://www.andreagrandi.it">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


      <a href="https://www.andreagrandi.it/feeds/all.rss.xml">RSS</a>
    </nav>



<article>
  <header>
    <h2><a href="https://www.andreagrandi.it/2023/04/17/how-to-use-openai-api-for-chatgpt-in-python/">HowTo use OpenAI API for ChatGPT in Python</a></h2>
    <p>
      Posted on Mon 17 April 2023 in <a href="https://www.andreagrandi.it/category/development.html">Development</a>

          &#8226; Tagged with
              <a href="https://www.andreagrandi.it/tag/python.html">python</a>,              <a href="https://www.andreagrandi.it/tag/development.html">development</a>,              <a href="https://www.andreagrandi.it/tag/chatgpt.html">chatgpt</a>,              <a href="https://www.andreagrandi.it/tag/openai.html">openai</a>,              <a href="https://www.andreagrandi.it/tag/artificial.html">artificial</a>,              <a href="https://www.andreagrandi.it/tag/intelligence.html">intelligence</a>,              <a href="https://www.andreagrandi.it/tag/machine.html">machine</a>,              <a href="https://www.andreagrandi.it/tag/learning.html">learning</a>,              <a href="https://www.andreagrandi.it/tag/tutorial.html">tutorial</a>,              <a href="https://www.andreagrandi.it/tag/howto.html">howto</a>,              <a href="https://www.andreagrandi.it/tag/api.html">api</a>
    </p>
  </header>
  <div>
      <p>How to use the OpenAI API for ChatGPT in Python</p>
        <br>
        <a class="btn"
           href="https://www.andreagrandi.it/2023/04/17/how-to-use-openai-api-for-chatgpt-in-python/">
          Continue reading
        </a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.andreagrandi.it/2018/04/14/machine-learning-pima-indians-diabetes/">Machine Learning: Pima Indians Diabetes</a></h2>
    <p>
      Posted on Sat 14 April 2018 in <a href="https://www.andreagrandi.it/category/development.html">Development</a>

          &#8226; Tagged with
              <a href="https://www.andreagrandi.it/tag/machine-learning.html">Machine Learning</a>,              <a href="https://www.andreagrandi.it/tag/python.html">Python</a>,              <a href="https://www.andreagrandi.it/tag/scikit-learn.html">scikit-learn</a>,              <a href="https://www.andreagrandi.it/tag/tutorial.html">tutorial</a>
    </p>
  </header>
  <div>
      <p>Solving the Pima Indians Diabetes problem with Machine Learning using Python and scikit-learn</p>
        <br>
        <a class="btn"
           href="https://www.andreagrandi.it/2018/04/14/machine-learning-pima-indians-diabetes/">
          Continue reading
        </a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.andreagrandi.it/2017/08/17/creating-a-production-ready-api-with-python-and-django-rest-framework-part-4/">Creating a production ready API with Python and Django Rest Framework – part 4</a></h2>
    <p>
      Posted on Thu 17 August 2017 in <a href="https://www.andreagrandi.it/category/development.html">Development</a>

          &#8226; Tagged with
              <a href="https://www.andreagrandi.it/tag/api.html">API</a>,              <a href="https://www.andreagrandi.it/tag/django.html">Django</a>,              <a href="https://www.andreagrandi.it/tag/framework.html">framework</a>,              <a href="https://www.andreagrandi.it/tag/python.html">Python</a>,              <a href="https://www.andreagrandi.it/tag/rest.html">rest</a>,              <a href="https://www.andreagrandi.it/tag/tutorial.html">tutorial</a>
    </p>
  </header>
  <div>
      <p>In the <a href="https://www.andreagrandi.it/2017/03/12/creating-a-production-ready-api-with-python-and-django-rest-framework-part-3/">previous
part</a>
of the tutorial we implemented <strong>details</strong> management, <strong>relations</strong>
between models, <strong>nested APIs</strong> and a different level of permissions.
Our API is basically complete but it is working properly? Is the source
code free of bugs? Would you feel confident to refactor the code without
breaking something? The answer to all our question is probably no. <strong>I
can't be sure if the code behaves properly nor I would feel confident
refactoring anything without having some tests coverage</strong>.</p>
<p>As I mentioned previously, we should have written tests since the
beginning, but I really didn't want to mix too many concepts together
and I wanted to let the user concentrate on the Rest Framework instead.</p>
<h3>Test structure and configuration</h3>
<p>Before beginning the fourth part of this tutorial, make sure you have
grabbed the latest source code
from <a href="https://github.com/andreagrandi/drf-tutorial">https://github.com/andreagrandi/drf-tutorial</a> and you have checked
out the previous git tag:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.14
</code></pre></div>

<p>Django has an integrated test runner but my personal choice is to use
<a href="https://doc.pytest.org/en/latest/"><strong>pytest</strong></a>, so as first thing let's
install the needed libraries:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>pytest-django
</code></pre></div>

<p>As long as we respect a minimum of conventions (test files must start
with <strong>test_</strong> prefix), tests can be placed anywhere in the code. My
advice is to put them all together in a separate folder and divide them
according to app names. In our case we are going to create a folder
named "<strong>tests</strong>" at the same level of <strong>manage.py</strong> file. Inside this
folder we need to create a <strong>__init__.py</strong> file and another folder
called <strong>catalog</strong> with an additional <strong>__init__.py</strong> inside. Now,
still at the same level of <strong>manage.py</strong> create a file called
<strong>pytest.ini</strong> with this content:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">pytest</span><span class="p">]</span>
<span class="n">DJANGO_SETTINGS_MODULE</span><span class="o">=</span><span class="n">drftutorial</span><span class="o">.</span><span class="n">settings</span>
</code></pre></div>

<p>Are you feeling confused? No problem. You can checkout the source code
containing these changes.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.15
</code></pre></div>

<p>You can check if you have done everything correctly going inside the
drftutorial folder (the one containing <strong>manage.py</strong>) and launching
<strong>pytest</strong>. If you see something like this, you did your changes
correctly:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>drf-tutorial<span class="o">)</span><span class="w"> </span>➜<span class="w">  </span>drftutorial<span class="w"> </span>git:<span class="o">(</span>master<span class="o">)</span><span class="w"> </span><span class="nv">pytest</span>
<span class="o">=============================================================================================================================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================================================================================================================</span>
platform<span class="w"> </span>darwin<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">2</span>.7.13,<span class="w"> </span>pytest-3.0.6,<span class="w"> </span>py-1.4.32,<span class="w"> </span>pluggy-0.4.0
Django<span class="w"> </span>settings:<span class="w"> </span>drftutorial.settings<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>ini<span class="w"> </span>file<span class="o">)</span>
rootdir:<span class="w"> </span>/Users/andrea/Projects/drf-tutorial/drftutorial,<span class="w"> </span>inifile:<span class="w"> </span>pytest.ini
plugins:<span class="w"> </span>django-3.1.2
collected<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">items</span>

<span class="o">=========================================================================================================================</span><span class="w"> </span>no<span class="w"> </span>tests<span class="w"> </span>ran<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="nv">seconds</span><span class="w"> </span><span class="o">=========================================================================================================================</span>
<span class="o">(</span>drf-tutorial<span class="o">)</span><span class="w"> </span>➜<span class="w">  </span>drftutorial<span class="w"> </span>git:<span class="o">(</span>master<span class="o">)</span>
</code></pre></div>

<h3>Writing the first test</h3>
<p>To begin with, I will show you how to write a simple test that will
verify if the API can return the products list. If you remember we
implemented this API in the first part of the tutorial. First of all
create a file called <strong>test_views.py</strong> under the folder
<strong>drftutorial/tests/catalog/</strong> and add this code:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.test</span> <span class="kn">import</span> <span class="n">APITestCase</span>


<span class="k">class</span> <span class="nc">TestProductList</span><span class="p">(</span><span class="n">APITestCase</span><span class="p">):</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
    <span class="k">def</span> <span class="nf">test_can_get_product_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;product-list&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()),</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></div>

<p>before being able to run this test we need to change a little thing in
the <strong>catalog/urls.py</strong> file, something we should have done since the
beginning. Please change the first url in this way, adding the <strong>name</strong>
parameter:</p>
<div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^products/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ProductList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;product-list&#39;</span><span class="p">),</span>
    <span class="o">...</span>
</code></pre></div>

<p>at this point we are able to run our test suite again and verify the
test is passing:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>drf-tutorial<span class="o">)</span><span class="w"> </span>➜<span class="w">  </span>drftutorial<span class="w"> </span>git:<span class="o">(</span>test-productlist<span class="o">)</span><span class="w"> </span>✗<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=============================================================================================================================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================================================================================================================</span>
platform<span class="w"> </span>darwin<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">2</span>.7.13,<span class="w"> </span>pytest-3.0.6,<span class="w"> </span>py-1.4.32,<span class="w"> </span>pluggy-0.4.0<span class="w"> </span>--<span class="w"> </span>/Users/andrea/.virtualenvs/drf-tutorial/bin/python2.7
cachedir:<span class="w"> </span>.cache
Django<span class="w"> </span>settings:<span class="w"> </span>drftutorial.settings<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>ini<span class="w"> </span>file<span class="o">)</span>
rootdir:<span class="w"> </span>/Users/andrea/Projects/drf-tutorial/drftutorial,<span class="w"> </span>inifile:<span class="w"> </span>pytest.ini
plugins:<span class="w"> </span>django-3.1.2
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>items

tests/catalog/test_views.py::TestProductList::test_can_get_product_list<span class="w"> </span><span class="nv">PASSED</span>

<span class="o">===========================================================================================================================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.98<span class="w"> </span><span class="nv">seconds</span><span class="w"> </span><span class="o">===========================================================================================================================</span>
</code></pre></div>

<p>To checkout the source code at this point:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.16
</code></pre></div>

<h3>Explaining the test code</h3>
<p>When we implement a test, the first thing to do is to create a
<strong>test_*</strong> file and import the minimum necessary to write a test class
and method. Each test class must inherit from <strong>APITestCase</strong> and have a
name that start with <strong>Test</strong>, like <strong>TestProductList</strong>. Since we use
<a href="https://doc.pytest.org/en/latest/">pytest</a>, we need to mark our method
with <strong>@pytest.mark.django_db decorator</strong>, to tell the test suite our
code will explicitly access the database. We are going to use the <strong>client</strong> object
that is integrated in APITestCase to perform the request. Before doing that we
first get the local <strong>url</strong> using Django's <strong>reverse</strong> function. At this point
we do the call using the client:</p>
<div class="highlight"><pre><span></span><code><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>and then we assert a couple of things that we expect to be true:</p>
<div class="highlight"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()),</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></div>

<p>We check that our API returns the <strong>200</strong> status code and that in the returned
JSON there are 8 elements.</p>
<p>It's normally a good practice to create test data inside the tests, but in our case
we previously created a data migration that creates test data. Migrations are
run every time we run tests so when we call our API, the data will be already there.</p>
<h3>Wrapping up</h3>
<p>I've written a <a href="https://github.com/andreagrandi/drf-tutorial/blob/master/drftutorial/tests/catalog/test_views.py">few tests</a> 
for all the views we have implemented until now and they are available
if you checkout this version of the code:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.17
</code></pre></div>

<p>I've only tested the views but it would be nice to test even the permission class, for example.
Please remember to write your tests first, if possible: implementing the code will be much more natural
once the tests are already in place.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.andreagrandi.it/2017/03/12/creating-a-production-ready-api-with-python-and-django-rest-framework-part-3/">Creating a production ready API with Python and Django Rest Framework – part 3</a></h2>
    <p>
      Posted on Sun 12 March 2017 in <a href="https://www.andreagrandi.it/category/development.html">Development</a>

          &#8226; Tagged with
              <a href="https://www.andreagrandi.it/tag/api.html">API</a>,              <a href="https://www.andreagrandi.it/tag/django.html">Django</a>,              <a href="https://www.andreagrandi.it/tag/framework.html">framework</a>,              <a href="https://www.andreagrandi.it/tag/python.html">Python</a>,              <a href="https://www.andreagrandi.it/tag/rest.html">rest</a>,              <a href="https://www.andreagrandi.it/tag/tutorial.html">tutorial</a>
    </p>
  </header>
  <div>
      <p>In the <a href="https://www.andreagrandi.it/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2/">previous
part</a>
we implemented authentication, permissions and the possibility to POST
new products for admins. In this new episode we will see how to
implement <strong>details</strong> management, <strong>relations</strong> between models, <strong>nested
APIs</strong> and a different level of permissions.</p>
<p>If you haven't completed the previous parts or if you want to begin from
this one, checkout the right code first:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.10
</code></pre></div>

<h3>Handling Product Details</h3>
<p>Our current API methods allow us to list all the products we have in our
catalog and to create a new one (if we have admin permissions), but what
if we wanted to delete or update a single one? What if we wanted to get
only a specific product? We need to handle details.</p>
<p>As first thing we need to change the <strong>ProductSerializer</strong> to return the
id of the product. Edit <strong>catalog/serializers.py</strong> and change the class
in this way:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Product</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">)</span>
</code></pre></div>

<p>After changing the serializer we need to implement a new view called
<strong>ProductDetail</strong>. Edit <strong>catalog/views.py</strong> and add the following
imports:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
</code></pre></div>

<p>and the following class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductDetail</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Product</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ProductSerializer</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ProductSerializer</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</code></pre></div>

<p>let's connect the new view to the urls, editing catalog/urls.py and
changing the code in this way:</p>
<div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^products/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ProductList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^products/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ProductDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</code></pre></div>

<p>If we try to <strong>PUT</strong>, <strong>DELETE</strong> or <strong>GET</strong> a product like
<strong>/products/1/</strong> we can now update, delete or retrieve an existing item,
but there is a little problem: we haven't set any permission on this
class, so anyone can do it. The previous view was also more compact, why
don't we use a generic view to perform these basic operations? Let's
refactor <strong>ProductDetail</strong> with a
<a href="http://www.django-rest-framework.org/api-guide/generic-views/#retrieveupdatedestroyapiview"><strong>RetrieveUpdateDestroyAPIView</strong></a>
generic class. Open <strong>catalog/views.py</strong> and change the class code in
this way:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ProductSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAdminOrReadOnly</span><span class="p">,</span> <span class="p">)</span>
</code></pre></div>

<p>That's it! With just three lines of code we have now implemented the
same feature of the previous class, plus we have set the correct
permissions.</p>
<p>To checkout the code at this point:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.12
</code></pre></div>

<h3>Reviews - Relations between models</h3>
<p>As many online catalogs already have, it would be nice if our API had an
endpoint where it is possible to leave a review for a product and get a
list of reviews for a specific product. To implement this feature we
need to add a new model to our application. Edit <strong>catalog/models.py</strong>
adding this import:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
</code></pre></div>

<p>and this Django model:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Review</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;reviews&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">review</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">created_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
</code></pre></div>

<p>after creating the model, please remember to create the related DB
<strong>migration</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./manage.py<span class="w"> </span>makemigrations<span class="w"> </span>catalog
</code></pre></div>

<p>When the model is ready, we have to do some changes to the serializers.
First of all we need to write a new one, for our new <strong>Review</strong> model.
Then we have to change our <strong>ProductSerializer</strong> so that it will return
its related reviews. Each Product can have multiple Review. And each
Review will be always linked to a specific Product. Edit
<strong>catalog/serializers.py</strong> and change it in this way:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span><span class="p">,</span> <span class="n">Review</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>


<span class="k">class</span> <span class="nc">ReviewSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">created_by</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;created_by.username&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Review</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;review&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;created_by&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProductSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">reviews</span> <span class="o">=</span> <span class="n">ReviewSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Product</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;reviews&#39;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Note:</strong> in <strong>ReviewSerializer</strong> when we serialise the user contained
in <strong>created_by</strong> field, return the username instead of the id (to make
it more human readable). Another important thing to notice is that the
value of the <strong>related_name</strong> we have set in the <strong>Review</strong> model must
match with the field name we have added in <strong>ProductSerializer fields</strong>
property. In this case we have set it to <strong>reviews</strong>.</p>
<p>At this point we need to add a new view. Edit <strong>catalog/views.py</strong> and
add the following imports:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticatedOrReadOnly</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span><span class="p">,</span> <span class="n">Review</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ProductSerializer</span><span class="p">,</span> <span class="n">ReviewSerializer</span>
</code></pre></div>

<p>then add this class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ReviewList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ReviewSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">product_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
</code></pre></div>

<p>As you can notice, I had to customise the <strong>perform_create</strong> method
because the default one doesn't know anything about the fact we want to
set the <strong>created_by</strong> and <strong>product_id</strong> fields. Finally we need to
bind this new view to a specific url, so we need to edit
<strong>catalog/urls.py</strong> and add this:</p>
<div class="highlight"><pre><span></span><code><span class="o">...</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^products/(?P&lt;pk&gt;[0-9]+)/reviews/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ReviewList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</code></pre></div>

<p>At this point any authenticated user should be able to <strong>POST a review</strong>
for a product and anyone should be able to get the <strong>list of reviews</strong>
for each product. If you have any problem with the code and want to move
to this point, please checkout this:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.13
</code></pre></div>

<h3>Nested APIs details</h3>
<p>To complete our API endpoints for Review, we need to add an additional
feature that will let users to edit/delete their own review. Before
implementing the new view, we need a little bit of refactoring and a new
permission class. Edit <strong>catalog/permissions.py</strong> and add this new
class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</code></pre></div>

<p>Basically this will permit changes to the review only to its author. Now
we are going to add new urls and doing some refactoring at the same
time. Edit <strong>catalog/urls.py</strong> and change the urls in this way:</p>
<div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^products/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ProductList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^products/(?P&lt;product_id&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ProductDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^products/(?P&lt;product_id&gt;[0-9]+)/reviews/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">ReviewList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()</span>
    <span class="p">),</span>
    <span class="n">url</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^products/(?P&lt;product_id&gt;[0-9]+)/reviews/(?P&lt;review_id&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">ReviewDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()</span>
    <span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>You may have noticed that I substituted <strong>pk</strong> with <strong>product_id</strong>. In
the latest url I added, we need to be able to identify two primary keys:
the one for the product and the one for the review. I renamed the
previous ones for consistency. Now it's time to add the new view for
Review details. Edit <strong>catalog/view.py</strong> and add this class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ReviewDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ReviewSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span> <span class="n">IsOwnerOrReadOnly</span><span class="p">)</span>
    <span class="n">lookup_url_kwarg</span> <span class="o">=</span> <span class="s1">&#39;review_id&#39;</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">review</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;review_id&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">review</span><span class="p">)</span>
</code></pre></div>

<p>What are we doing here? You may have noticed that we set a new property
called <strong>lookup_url_kwarg</strong>. That property is being used to determine
the keyword in <strong>urls.py</strong> to be used for the primary key lookup.</p>
<p>You will also need to do some refactoring to the other views, to adapt
them to the changes we just did to the urls. I suggest you to have a
look at the diffs
here: <a href="https://github.com/andreagrandi/drf-tutorial/compare/tutorial-1.13...tutorial-1.14">https://github.com/andreagrandi/drf-tutorial/compare/tutorial-1.13...tutorial-1.14</a>
or you can have a look at the whole file
here <a href="https://github.com/andreagrandi/drf-tutorial/blob/541bf31c11fd1dbf2bcc1d31312086995e3e5b48/drftutorial/catalog/views.py">https://github.com/andreagrandi/drf-tutorial/blob/541bf31c11fd1dbf2bcc1d31312086995e3e5b48/drftutorial/catalog/views.py</a></p>
<p>In alternative, you can fetch the whole source code at this point:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>tutorial-1.14
</code></pre></div>

<h3>Wrapping Up</h3>
<p>In this third part of the tutorial you learned how to handle model
details in the API and how relations between different model work. In
the <a href="https://www.andreagrandi.it/2017/08/17/creating-a-production-ready-api-with-python-and-django-rest-framework-part-4/">next part of the tutorial</a>
we will do something we should have done since the beginning: adding <strong>tests</strong> to 
our code and learn how to properly
test the API.</p>
<h3>Feedback Please</h3>
<p>If you enjoyed this tutorial, please leave me some feedback!
I really want to improve my work, based on the users feedback so any little advice will be appreciated, thanks!</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn float-left" href="https://www.andreagrandi.it/tag/tutorial2.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
  </div>



    <footer>
<p>
  &copy; 2023  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
  Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme - source code available on <a href="https://github.com/andreagrandi/andreagrandi.it" target="_blank">GitHub</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="images/by-sa.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Andrea Grandi ",
  "url" : "https://www.andreagrandi.it",
  "image": "/images/me_pycon_2019_2_300x300.jpg",
  "description": ""
}
</script>

  <script>
    $(document).ready(function () {
      $('#tipue_search_input').tipuesearch();
    });
  </script>

</body>

</html>