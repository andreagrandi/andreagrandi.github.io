<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Andrea Grandi - rest</title>
        <link rel="stylesheet" href="https://www.andreagrandi.co.uk/theme/css/main.css" />
        <link rel="stylesheet" href="https://www.andreagrandi.co.uk/theme/tipuesearch/css/tipuesearch.css">
        <link href="https://www.andreagrandi.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Andrea Grandi Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://www.andreagrandi.co.uk/">Andrea Grandi </a></h1>
                <nav><ul>
    
                        <li><a href="https://www.andreagrandi.co.uk/about/">About</a></li>
    
                        <li><a href="https://www.andreagrandi.co.uk/curriculum/">Curriculum</a></li>
    
                        <li><a href="https://www.andreagrandi.co.uk/pgp-key/">PGP Key</a></li>
                </ul>
<form id="search" action="https://www.andreagrandi.co.uk/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                        <input type="text" class="search-query" placeholder="" name="q" id="tipue_search_input">
                    </form>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://www.andreagrandi.co.uk/2016/10/01/creating-a-production-ready-api-with-python-and-django-rest-framework-part-2/">Creating a production ready API with Python and Django Rest Framework â€“ part 2</a></h1>
<footer class="post-info">
        <span>Sat 01 October 2016</span>
<span>| tags: <a href="https://www.andreagrandi.co.uk/tag/api.html">API</a><a href="https://www.andreagrandi.co.uk/tag/django.html">Django</a><a href="https://www.andreagrandi.co.uk/tag/framework.html">framework</a><a href="https://www.andreagrandi.co.uk/tag/python.html">Python</a><a href="https://www.andreagrandi.co.uk/tag/rest.html">rest</a><a href="https://www.andreagrandi.co.uk/tag/tutorial.html">tutorial</a></span>
</footer><!-- /.post-info --><p>In the <a href="https://www.andreagrandi.co.uk/2016/09/28/creating-production-ready-api-python-django-rest-framework-part-1/">first
part</a>
of this tutorial we have seen how to create a basic API using <strong>Django
Rest Framework</strong>. This second part will explain how to implement
<strong>POST</strong> methods and add different levels of <strong>permissions</strong> and
<strong>authentication</strong>. If you are starting from part 2, you may want to
checkout the source code at this exact point:</p>
<div class="highlight"><pre><span></span>git checkout tutorial-1.4
</pre></div>


<h3>A step back</h3>
<p>Before showing how easy it is to implement a <strong>POST</strong> method for our
existing API, I want to do a step back and show you the "manual way",
using just the
<a href="http://www.django-rest-framework.org/api-guide/views/"><strong>APIView</strong></a>
class. Edit the file <strong>catalog/views.py</strong> and change the code in this
way:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ProductSerializer</span>


<span class="k">class</span> <span class="nc">ProductList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ProductSerializer</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>


<p>If we try to use the API again (from the browser of from the http
client), it will still work in the same way. The difference here is that
we are using the very basic <strong>APIView</strong> class and we have explicitly
defined the <strong>GET</strong> method for it.</p>
<h3>Implementing a POST method with APIView</h3>
<p>An API is not being used at its full potential if it's read only. We are
going to implement a POST method for the existing view and testing it
with <a href="https://httpie.org/"><strong>httpie</strong></a> client again. First of all we
need to add an import to <strong>catalog/views.py</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
</pre></div>


<p>then we add this method to our <strong>ProductList</strong> class:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">ProductSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</pre></div>


<p>Now let's test our <strong>POST</strong> method we just implemented:</p>
<div class="highlight"><pre><span></span>$ http --json POST http://127.0.0.1:8000/products/ <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Salamino&quot;</span> <span class="nv">description</span><span class="o">=</span><span class="s2">&quot;Salamino Piccante&quot;</span> <span class="nv">price</span><span class="o">=</span><span class="s2">&quot;10.50&quot;</span>
HTTP/1.0 <span class="m">201</span> Created
Allow: GET, POST, HEAD, OPTIONS
Content-Type: application/json
Date: Thu, <span class="m">29</span> Sep <span class="m">2016</span> <span class="m">11</span>:48:48 GMT
Server: WSGIServer/0.1 Python/2.7.10
Vary: Accept, Cookie
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Salamino Piccante&quot;</span>,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Salamino&quot;</span>,
    <span class="s2">&quot;price&quot;</span>: <span class="s2">&quot;10.50&quot;</span>
<span class="o">}</span>
</pre></div>


<p>It works! In case something doesn't work, try to fetch the source code
at this point:</p>
<div class="highlight"><pre><span></span>git checkout tutorial-1.7
</pre></div>


<h3>Implementing a POST method with ListCreateAPIView</h3>
<p>Do you remember when I mentioned at the beginning that there is an easy
way to do the same thing? I wasn't cheating. Let's change again our old
code in <strong>catalog/views.py</strong> but this time we will use a different base
class:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Product</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ProductSerializer</span>


<span class="k">class</span> <span class="nc">ProductList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ProductSerializer</span>
</pre></div>


<p>let's test this again with <strong>httpie</strong>:</p>
<div class="highlight"><pre><span></span>$ http --json POST http://127.0.0.1:8000/products/ <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Pecorino&quot;</span> <span class="nv">description</span><span class="o">=</span><span class="s2">&quot;Pecorino Sardo&quot;</span> <span class="nv">price</span><span class="o">=</span><span class="s2">&quot;7.00&quot;</span>
HTTP/1.0 <span class="m">201</span> Created
Allow: GET, POST, HEAD, OPTIONS
Content-Type: application/json
Date: Thu, <span class="m">29</span> Sep <span class="m">2016</span> <span class="m">15</span>:21:20 GMT
Server: WSGIServer/0.1 Python/2.7.10
Vary: Accept, Cookie
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Pecorino Sardo&quot;</span>,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Pecorino&quot;</span>,
    <span class="s2">&quot;price&quot;</span>: <span class="s2">&quot;7.00&quot;</span>
<span class="o">}</span>
</pre></div>


<p>We just POSTed some data on the API! How can it work? Well, we have
changed the base class from <strong>ListAPIView</strong> to
<a href="http://www.django-rest-framework.org/api-guide/generic-views/#listcreateapiview"><strong>ListCreateAPIView</strong></a>.
This particular class implements <strong>a generic POST method</strong> that will
accept and validate all the fields through the specified serializer.</p>
<h3>Authentication</h3>
<p>Now our API let us add products to the catalog, amazing! But... is it
exactly what we want? In a real scenario we don't want any random user
to be able to add products in our database, so we are going to protect
the POST method allowing only Admin users.</p>
<p>Before digging into Django Rest Framework permissions, we need to setup
an authentication system. For simplicity we will implement
<a href="http://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication"><strong>TokenAuthentication</strong></a>.
As first step we need to edit <strong>settings.py</strong> and
insertÂ <strong>rest_framework.authtoken</strong> in the <strong>INSTALLED_APPS</strong>:</p>
<div class="highlight"><pre><span></span>    <span class="o">...</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework.authtoken&#39;</span><span class="p">,</span>
    <span class="s1">&#39;catalog&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>


<p>after this, we need to add <strong>TokenAuthentication</strong> as default
authentication class (append this in <strong>settings.py</strong> at the end):</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.authentication.TokenAuthentication&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>Finally we need to add a particular URL to the project so that clients
will be able to call an endpoint passing <strong>username</strong> and <strong>password</strong>
to get a <strong>token</strong> back. Edit <strong>drftutorial/urls.py</strong> and make it's like
this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">rest_framework.authtoken.views</span> <span class="kn">import</span> <span class="n">obtain_auth_token</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;catalog.urls&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-token-auth/&#39;</span><span class="p">,</span> <span class="n">obtain_auth_token</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<p>Don't forget to re-run the <strong>migrations</strong>, because TokenAuthorization
needs to change a couple of tables:</p>
<div class="highlight"><pre><span></span>$ ./manage.py migrate
Operations to perform:
    Apply all migrations: admin, auth, authtoken, catalog, contenttypes, sessions
Running migrations:
    Applying authtoken.0001_initial... OK
    Applying authtoken.0002_auto_20160226_1747... OK
</pre></div>


<p>In case you had any problem changing the code up to this point, you can
always fetch the related git tag:</p>
<div class="highlight"><pre><span></span>git checkout tutorial-1.9
</pre></div>


<h4>Testing the Authentication</h4>
<p>Before testing the authentication, make sure you created at least the
Django <strong>superuser</strong> with:</p>
<div class="highlight"><pre><span></span>$ ./manage.py createsuperuser
</pre></div>


<p>now let's try to <strong>obtain the token</strong> we will need later for our API
calls:</p>
<div class="highlight"><pre><span></span>$ http --json POST http://127.0.0.1:8000/api-token-auth/ <span class="nv">username</span><span class="o">=</span><span class="s2">&quot;yourusername&quot;</span> <span class="nv">password</span><span class="o">=</span><span class="s2">&quot;yourpassword&quot;</span>
HTTP/1.0 <span class="m">200</span> OK
Allow: POST, OPTIONS
Content-Type: application/json
Date: Fri, <span class="m">30</span> Sep <span class="m">2016</span> <span class="m">08</span>:55:07 GMT
Server: WSGIServer/0.1 Python/2.7.11
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;token&quot;</span>: <span class="s2">&quot;bc9514f0892368cfd0ea792a977aff55d53e3634&quot;</span>
<span class="o">}</span>
</pre></div>


<p>We will need to pass this token in every API call we want to be
authenticated. The token is being passed through the "Authentication"
header parameter.</p>
<h3>API Permissions</h3>
<p>Authentication is something that identify the user with a particular
system. Permissions instead are the level of things that are allowed or
not allowed for a particular user. In our case we said we want to let
Admin users to be able to POST new products and we want to let even
anonymous users to GET the product list.</p>
<p>Django Rest Framework has some built-in classes that we can apply to our
views to define the level of permissions. We could have used the
<a href="http://www.django-rest-framework.org/api-guide/permissions/#isadminuser"><strong>IsAdminUser</strong></a>
class, but it would not allow anonymous users to perform the GET
request. Or we could have used
<a href="http://www.django-rest-framework.org/api-guide/permissions/#isauthenticatedorreadonly"><strong>IsAuthenticatedOrReadOnly</strong></a>
class, but this would allow any registered user to add products (and we
want to let only admins).</p>
<p>Or...we can define our own permission class and have exactly what we
want. Create a new file <strong>catalog/permissions.py</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span><span class="p">,</span> <span class="n">SAFE_METHODS</span>


<span class="k">class</span> <span class="nc">IsAdminOrReadOnly</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span>
</pre></div>


<p>Just as a side note, <strong>SAFE_METHODS</strong> are <strong>GET</strong>, <strong>HEAD</strong> and
<strong>OPTIONS</strong>. These method are considered "safe" because they don't
change any existing data. Open <strong>catalog/views.py</strong> again, import this
at the beginning:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.permissions</span> <span class="kn">import</span> <span class="n">IsAdminOrReadOnly</span>
</pre></div>


<p>and set this as <strong>permission_classes</strong> to <strong>ProductList</strong>:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ProductSerializer</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAdminOrReadOnly</span><span class="p">,</span> <span class="p">)</span>
</pre></div>


<p>Let's now try to add a new product using the <strong>token</strong> we got before
(you will have to use your own token of course, mine only works on my
local db):</p>
<div class="highlight"><pre><span></span>$ http --json POST http://127.0.0.1:8000/products/ <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Lardo&quot;</span> <span class="nv">description</span><span class="o">=</span><span class="s2">&quot;Lardo di Colonnata&quot;</span> <span class="nv">price</span><span class="o">=</span><span class="s2">&quot;8.50&quot;</span> <span class="s1">&#39;Authorization: Token bc9514f0892368cfd0ea792a977aff55d53e3634&#39;</span>
HTTP/1.0 <span class="m">201</span> Created
Allow: GET, POST, HEAD, OPTIONS
Content-Type: application/json
Date: Fri, <span class="m">30</span> Sep <span class="m">2016</span> <span class="m">13</span>:04:13 GMT
Server: WSGIServer/0.1 Python/2.7.11
Vary: Accept
X-Frame-Options: SAMEORIGIN

<span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Lardo di Colonnata&quot;</span>,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Lardo&quot;</span>,
    <span class="s2">&quot;price&quot;</span>: <span class="s2">&quot;8.50&quot;</span>
<span class="o">}</span>
</pre></div>


<p>It worked! We have now protected our API so that not admin people can't
create any product. If you have any problem with the code, you can check
it out with this tag:</p>
<div class="highlight"><pre><span></span>git checkout tutorial-1.10
</pre></div>


<h3>Wrapping Up</h3>
<p>We have now implemented the POST method to add new products to our
catalog. In the <a href="https://www.andreagrandi.co.uk/2017/03/12/creating-a-production-ready-api-with-python-and-django-rest-framework-part-3/">next
episode</a>
we will see how to implement endpoints to getÂ a single product, to
update or delete products and finally we will allow registered users to
send a review for a specific product.</p>
<h3>Feedback Please</h3>
<p>I know, this blog doesn't have any "comment" feature (I was tired of
dealing with spam), but if you want to provide some feedback you can
still do it by email. Just visit my
<a href="https://www.andreagrandi.co.uk/about/"><strong>About</strong></a> page, you will find my
email there.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://www.andreagrandi.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/andreagrandi">twitter</a></li>
                            <li><a href="https://github.com/andreagrandi">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>